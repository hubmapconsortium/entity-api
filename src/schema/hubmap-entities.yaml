############################################# Rules #############################################
# - By default, the schema treats all entity attributes as optional. Use `required: true` to mark an attribute as required
# - By default, the schema treats all entity attributes as mutable. Use `immutable: true` to mark an attribute as immutable
# - By default, the schema treats all entity attributes as persistent. Use `transient: true` to mark an attribute as transient
# - If an attribute is marked as `required: true`, it can't have `trigger` at the same time
# - If an attribute has `trigger` metadata, it can't be used in client request JSON
# - If an attribute has `on_read` trigger event, it must be transient, meaning it's not stored in neo4j and only available during response
# - There are 3 types of triggers: `on_create_trigger`, `on_update_trigger`, and `on_read_trigger`

############################################# Shared #############################################
doi_attribs: &doi_attribs 
  registered_doi:
    type: string
    description: "The doi of the registered entity"
  doi_url:
    type: string
    description: "The url from the doi registry for this entity"
  creator_uuids:
    type: list
    description: "An ordered list of uuids referencing the people who created the entity"
  contact_uuids:
    type: list
    description: "An ordered list of the HuBMAP uuids pointing to the people who are the main contacts about this entity"
    on_create_trigger: fill_contacts
    on_update_trigger: fill_contacts 
  ###### Transient attributes ######
  creators:
    transient: true
    type: application/json
    description: "An ordered list of the people who created the entity with full name, email, ORCID iD, institution, etc.. This is analogus to the author list on a publication."
    on_read_trigger: get_creators
  contacts:
    transient: true
    type: application/json # Will probably just go with "json" - Joe
    description: "An ordered array of the people who are the main contacts to get information about the entity."
    on_read_trigger: get_contacts #this will add all of the contact information when returned by looping through contact_ids list and calling Person ws


# All entities in neo4j have these properties
prov_attribs: &prov_attribs
  created_timestamp:
    type: integer
    immutable: true
    on_create_trigger: get_current_timestamp
  created_by_user_displayname:
    type: string
    on_create_trigger: get_user_name
    immutable: true
  created_by_user_email:
    type: string
    on_create_trigger: get_user_email
    immutable: true
  created_by_user_sub: # I don't fine this in Collection in the current neo4j
    type: string
    on_create_trigger: get_user_sub
    immutable: true
  last_modified_timestamp:
    type: integer
    on_update_trigger: get_current_timestamp
  last_modified_user_sub:
    type: string
    on_update_trigger: get_user_sub
  last_modified_user_email:
    type: string
    on_update_trigger: get_user_email
  last_modified_user_displayname:
    type: string
    on_update_trigger: get_user_name


id_attribs: &id_attribs
  uuid:
    type: string
    on_create_trigger: create_uuid
    immutable: true
  doi_suffix_id:
    type: string
    on_create_trigger: create_doi_suffix_id
    immutable: true
  hubmap_id:
    type: string
    immutable: true
    on_create_trigger: create_hubmap_id


other_shared_attribs: &other_shared_attribs
  entity_type:
    type: string
    immutable: true
    on_create_trigger: get_entity_type 
  description:
    type: string
  data_access_level: # Only Dataset can have "protected" value
    type: string
    on_create_trigger: get_data_access_level
    on_update_trigger: get_data_access_level


ENTITIES:
  ############################################# Collection #############################################
  Collection:
    attributes:
      <<: *id_attribs
      <<: *prov_attribs
      <<: *doi_attribs
      <<: *other_shared_attribs
      title:
        required: true
        type: string
      has_doi:
        type: boolean
        default_value: false
        description: "True if the entity has a doi registered for it, false otherwise"
      ###### Transient attributes ######
      dataset_uuids:  #used only to pass the reference to linked datasets in on a PUT/POST
        transient: true
        type: list
        description: "list of dataset uuids that the collection is connected to.  This list is not stored in the database, but used at PUT or POST time to link the Collection to associated Datasets"
        transient: true # Never save to databse
        on_read_trigger: get_dataset_uuids #when responding to a GET, include the list of dataset ids
      creators:
        transient: true
        type: application/json
        description: "An ordered list of the people who created the entity with full name, email, ORCID iD, institution, etc.. This is analogus to the author list on a publication."
        on_read_trigger: get_creators #this will add all of the creator information when returned by looping through creator_ids list and calling Person ws

  ############################################# Dataset #############################################
  Dataset:
    attributes:
      <<: *id_attribs
      <<: *prov_attribs
      <<: *doi_attribs
      <<: *other_shared_attribs
      # Why not add a property to Dataset and indicate the collections that Dataset belongs to?
      # Then we don't have to maintain the associated Dataset nodes in Collection - Joe
      title:
        required: true
        type: string
      data_types:
        type: string
      collection_uuids:
        transient: true
        type: list
        on_create_trigger: create_in_collection_relationship
        on_update_trigger: update_in_collection_relationship
        on_read_trigger: get_collection_uuids
      published_timestamp: # Can we unpublish a Dataset, immutable or not? - Joe
        type: integer
      published_user_displayname:
        type: string
      published_user_sub:
        type: string
      published_user_email:
        type: string
      pipeline_message:
        type: string
      dataset_name:
        type: string
      contains_human_genetic_sequences:
        type: string
      ingest_metadata:
        type: string
      local_directory_rel_path:
        type: string
      status:
        type: string
      run_id:
        type: string
      ingest_id:
        type: string
      local_directory_url_path:
        type: string

  ############################################# Donor #############################################
  Donor:
    attributes:
      <<: *id_attribs
      <<: *prov_attribs
      <<: *doi_attribs
      <<: *other_shared_attribs
      image_file_metadata:
        type: string
      metadata:
        type: string
      protocol_url:
        type: string
      lab_donor_id:
        type: string
      submission_id:
        type: string
      portal_metadata_upload_files:
        type: string
      next_identifier:
        type: string
      label:
        type: string
      protocol_file:
        type: string
      open_consent:
        type: string

  ############################################# Sample #############################################
  Sample:
    attributes:
      <<: *id_attribs
      <<: *prov_attribs
      <<: *doi_attribs
      <<: *other_shared_attribs
      protocol_file:
        type: string
      specimen_type:
        type: string
      portal_metadata_upload_files:
        type: string
      protocol_url:
        type: string
      protocol_info:
        type: string
      image_file_metadata:
        type: string
      sample_count:
        type: string
      organ_other:
        type: string
      submission_id:
        type: string
      organ:
        type: string
      lab_tissue_sample_id:
        type: string
      next_identifier:
        type: string
      metadata:
        type: string
      rui_location:
        type: string
      specimen_type_other:
        type: string
      visit:
        type: string

