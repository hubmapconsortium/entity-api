############################################# Rules #############################################
# - By default, the schema treats all entity properties as optional. Use `user_input_required: true` to mark a property as user_input_required
# - By default, the schema treats all entity properties as mutable. Use `immutable: true` to mark a property as immutable
# - By default, the schema treats all entity properties as persistent. Use `transient: true` to mark a property as transient
# - By default, the schema treats all entity properties as they have no triggers. Specify the trigger methods if needed
# - If a property is marked as `user_input_required: true`, it means this property is required to be provided in the client request JSON
# - If a property is marked as `user_input_required: true`, it can't have `trigger` at the same time
# - If a property has `trigger` metadata, it can't be used in client request JSON
# - If a property has `on_read` trigger event, it must be transient, meaning it's not stored in neo4j and only available during response
# - There are 3 types of triggers: `on_create_trigger`, `on_update_trigger`, and `on_read_trigger`

############################################# TO-DO #############################################
# - Add a description metadata to each property
# - Verify and mark all `user_input_required` properties
# - Clarify the use of `title` and `label` properties across all the entities
# - Verify and mark all `immutable` properties

# Shared properties across ACTIVITIES and ENTITIES
shared_properties: &shared_properties
  ###### Creation info properties ######
  created_timestamp:
    type: integer
    immutable: true
    on_create_trigger: get_current_timestamp
  created_by_user_displayname:
    type: string
    on_create_trigger: get_user_name
    immutable: true
  created_by_user_email:
    type: string
    on_create_trigger: get_user_email
    immutable: true
  created_by_user_sub: # I don't fine this in Collection in the current neo4j
    type: string
    on_create_trigger: get_user_sub
    immutable: true
  ###### ID properties ######
  uuid:
    type: string
    description: "E.g., 461bbfdc353a2673e381f632510b0f17"
    on_create_trigger: create_uuid
    immutable: true
  doi_suffix_id:
    type: string
    description: "E.g., 456FDTP455"
    on_create_trigger: create_doi_suffix_id
    immutable: true
  hubmap_id:
    type: string
    description: "E.g., VAN0002"
    immutable: true
    on_create_trigger: create_hubmap_id

####################################################################################################
## Activities
####################################################################################################

ACTIVITIES:
  # Will we have more activity types?
  Activity:
    properties:
      <<: *shared_properties
      creation_action:
        type: string
        description: "E.g., Create Dataset Activity"
        immutable: true
        on_create_trigger: get_activity_creation_action


####################################################################################################
## Entities
####################################################################################################

shared_entity_properties: &shared_entity_properties 
  ###### DOI properties ######
  registered_doi:
    type: string
    immutable: true
    description: "The doi of the registered entity"
  doi_url:
    type: string
    immutable: true
    description: "The url from the doi registry for this entity"
  # All the `last_modified_*` properties are not immutable
  last_modified_timestamp:
    type: integer
    on_update_trigger: get_current_timestamp
  last_modified_user_sub:
    type: string
    on_update_trigger: get_user_sub
  last_modified_user_email:
    type: string
    on_update_trigger: get_user_email
  last_modified_user_displayname:
    type: string
    on_update_trigger: get_user_name
  ###### Shared transient properties ######
  data_access_level:
    transient: true
    type: string
    description: "One of the values: public, consortium, protected. Only Dataset may have protected value"
    on_read_trigger: get_data_access_level
  ###### All other shared properties ######
  entity_class:
    type: string
    description: "One of the normalized entity types: Dataset, Collection, Sample, Donor"
    immutable: true
    on_create_trigger: get_entity_class 
  # Currently cretors and contacts are only available for Collection
  creators:
    type: list
    description: "A list of the people who created the entity with full name, email, ORCID iD, institution, etc.. This is analogus to the author list on a publication."
  contacts:
    type: list 
    description: "A list of the people who are the main contacts to get information about the entity."
  # To-DO
  # creator_ids:
  #   type: list
  #   immutable: true
  #   description: "A list of ids (will need to decide on uuid or orcid id) referencing the people who created the entity"
  # contact_ids:
  #   type: list
  #   description: "A list of ids (will need to decide on uuid or orcid id) referencing the people who are the main contacts about this entity"
  

# Note: don't relate the entities schema to the neo4j data modeling
ENTITIES:
  ############################################# Collection #############################################
  Collection:
    # Collection can not be derivation source nor target
    derivation:
      source: false
      target: false
    properties:
      <<: *shared_properties
      <<: *shared_entity_properties
      title:
        user_input_required: true
        type: string
      has_doi:
        type: boolean
        description: "True if the entity has a doi registered for it, false otherwise/default"
      ###### Transient properties ######
      dataset_uuids:  #used only to pass the reference to linked datasets in on a PUT/POST
        transient: true
        type: list
        description: "A list of dataset uuids that belong to this collection"
        transient: true
        on_read_trigger: get_dataset_uuids_by_collection

  ############################################# Dataset #############################################
  Dataset:
    # Dataset can be either derivation source or target
    derivation:
      source: true
      target: true
    properties:
      <<: *shared_properties
      <<: *shared_entity_properties
      title:
        user_input_required: true
        type: string
      data_types:
        user_input_required: true
        type: string
      collection_uuids:
        transient: true
        type: list
        description: "A list of collection uuids that this dataset belongs to"
      source_uuids:
        transient: true
        type: list
        description: "The uuids of source entities from which this new entity is derived from"
        on_read_trigger: get_source_uuids
      published_timestamp: # Can we unpublish a Dataset, immutable or not? - Joe
        type: integer
      published_user_displayname:
        type: string
      published_user_sub:
        type: string
      published_user_email:
        type: string
      pipeline_message:
        type: string
      dataset_name:
        type: string
      # The Dataset.data_access_level is based on Dataset.status and Dataset.contains_human_genetic_sequences
      contains_human_genetic_sequences:
        user_input_required: true
        type: boolean
        description: "Will this data contain any human genomic sequence data?"
      ingest_metadata:
        type: string
      local_directory_rel_path:
        type: string
      # The Dataset.data_access_level is based on Dataset.status and Dataset.contains_human_genetic_sequences
      status:
        type: string
        description: "Published|New|QA|Error|Hold|Invalid"
      run_id:
        type: string
      ingest_id:
        type: string
      local_directory_url_path:
        type: string
      group_uuid:
        type: string
      group_name:
        type: string
      

  ############################################# Donor #############################################
  Donor:
    # Dnor can be derivation source but not target
    derivation:
      source: false
      target: true
    properties:
      <<: *shared_properties
      <<: *shared_entity_properties
      # Need `title` property?
      # Deidentified Name?
      image_file_metadata:
        type: string
      metadata:
        type: string
      protocol_url:
        user_input_required: true
        type: string
      lab_donor_id:
        type: string
      source_uuids:
        transient: true
        type: list
        description: "The uuids of source entities from which this new entity is derived from"
        on_read_trigger: get_source_uuids
      submission_id:
        type: string
      portal_metadata_upload_files:
        type: string
      next_identifier:
        type: string
      label:
        type: string
      protocol_file:
        type: string
      open_consent:
        type: string


  ############################################# Sample #############################################
  Sample:
    # Sample can be either derivation source or target
    derivation:
      source: true
      target: true
    properties:
      <<: *shared_properties
      <<: *shared_entity_properties
      # Need `title` property?
      # How to specify the source HuBMAP id of a new sample?
      protocol_file:
        type: string
      specimen_type:
        user_input_required: true
        type: string
      portal_metadata_upload_files:
        type: string
      protocol_url:
        type: string
      image_file_metadata:
        type: string
      sample_count:
        type: string
      organ_other:
        type: string
      source_uuids:
        transient: true
        type: list
        description: "The uuids of source entities from which this new entity is derived from"
        on_read_trigger: get_source_uuids
      submission_id:
        type: string
      organ:
        type: string
      lab_tissue_sample_id:
        type: string
      next_identifier:
        type: string
      metadata:
        type: string
      rui_location:
        type: string
      specimen_type_other:
        type: string
      visit:
        type: string

